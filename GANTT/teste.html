<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Gantt por Obra</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            font-family: Arial, sans-serif;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 4px;
            text-align: center;
        }

        th.month {
            background-color: #eee;
        }

        th.day {
            background-color: #f9f9f9;
            width: 30px;
        }

        td.etapas {
            text-align: left;
            white-space: nowrap;
        }

        .fim-de-semana {
            background-color: #ffdada !important;
        }

        .bar {
            height: 20px;
            margin: 2px 0;
        }

        /* Estilos específicos para cada tipo de imagem */
        .posproducao {
            background-color: #e3f2fd;
            border: none !important;
        }

        .finalizacao {
            background-color: #e8f5e9;
            border: none !important;
        }

        .modelagem {
            background-color: #fff3e0;
            border: none !important;
        }

        .caderno {
            background-color: #fce4ec;
            border: none !important;
        }

        .composicao {
            background-color: #f9ffc6;
            border: none !important;
        }

        .plantahumanizada {
            background-color: #d0edf5;
            border: none !important;
        }

        .filtrodeassets {
            background-color: #dcffec;
            border: none !important;
        }
    </style>
</head>

<body>

    <h2>Gantt - Obra: <span id="obraNome"></span></h2>

    <table id="ganttTable">
        <thead>
            <tr id="headerMeses"></tr>
            <tr id="headerDias"></tr>
        </thead>
        <tbody id="ganttBody"></tbody>
    </table>

    <script>
        // Função para gerar array de datas do período
        function gerarDatas(primeiraData, ultimaData) {
            const datas = [];
            let atual = new Date(primeiraData);
            let fim = new Date(ultimaData);

            // Garantir que ambas estão com hora zero
            atual.setHours(0, 0, 0, 0);
            fim.setHours(0, 0, 0, 0);

            while (atual <= fim) {
                datas.push(new Date(atual)); // nova instância da data
                atual.setDate(atual.getDate() + 1);
            }

            return datas;
        }
        // Função para formatar mês "Abr 2025"
        function formatarMes(data) {
            return data.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
        }

        // Função para montar cabeçalho com meses e dias
        function montarCabecalho(datas) {
            const headerMeses = document.getElementById('headerMeses');
            const headerDias = document.getElementById('headerDias');
            headerMeses.innerHTML = '';
            headerDias.innerHTML = '';

            const cellBranco = document.createElement('th');
            headerMeses.appendChild(cellBranco);
            headerDias.appendChild(cellBranco);

            let mesAtual = '';
            let mesContador = 0;

            datas.forEach((data, i) => {
                const mesFormat = formatarMes(data);
                if (mesFormat !== mesAtual) {
                    if (mesAtual !== '') {
                        const th = document.createElement('th');
                        th.className = 'month';
                        th.colSpan = mesContador;
                        th.innerText = mesAtual;
                        headerMeses.appendChild(th);
                    }
                    mesAtual = mesFormat;
                    mesContador = 1;
                } else {
                    mesContador++;
                }

                if (i === datas.length - 1) {
                    const th = document.createElement('th');
                    th.className = 'month';
                    th.colSpan = mesContador;
                    th.innerText = mesAtual;
                    headerMeses.appendChild(th);
                }
            });

            // Preencher linha de dias
            datas.forEach(data => {
                const th = document.createElement('th');
                th.className = 'day';

                const diaSemana = data.getDay(); // 0 = domingo, 6 = sábado
                if (diaSemana === 0 || diaSemana === 6) {
                    th.style.backgroundColor = '#ffe0e0'; // destaque para final de semana
                    th.style.fontWeight = 'bold';
                }

                th.innerText = data.getDate();
                headerDias.appendChild(th);
            });
        }

        // Montar o corpo da tabela com imagens e etapas
        function montarCorpo(imagens, etapas, datas) {
            const tbody = document.getElementById('ganttBody');
            tbody.innerHTML = '';

            function criarDataLocal(dataStr) {
                const [ano, mes, dia] = dataStr.split('-').map(Number);
                return new Date(ano, mes - 1, dia); // mes é zero-based no JS
            }

            function zerarHorario(data) {
                return new Date(data.getFullYear(), data.getMonth(), data.getDate());
            }

            function calcularDataFim(dataInicio, diasUteis, datas) {
                let contador = 0;
                const inicio = criarDataLocal(dataInicio);

                for (let i = 0; i < datas.length; i++) {
                    const d = datas[i];
                    d.setHours(0, 0, 0, 0);

                    if (d >= inicio) {
                        const diaSemana = d.getDay();
                        if (diaSemana !== 0 && diaSemana !== 6) { // útil
                            contador++;
                        }
                        if (contador === diasUteis) {
                            return d;
                        }
                    }
                }
                return datas[datas.length - 1];
            }


            Object.keys(imagens).forEach(tipo => {
                imagens[tipo].forEach(img => {
                    const tr = document.createElement('tr');

                    // Info da linha
                    const tdInfo = document.createElement('td');
                    tdInfo.className = 'etapas';
                    tdInfo.innerHTML = `<strong>${tipo}</strong> | ${img.nome} <br>`;
                    tr.appendChild(tdInfo);

                    // Pega as etapas dessa imagem
                    const etapasTipo = (etapas[tipo] || []).filter(e => e.imagem_id === img.imagem_id);
                    etapasTipo.sort((a, b) => new Date(a.data_inicio) - new Date(b.data_inicio));

                    // Para cada dia do período
                    datas.forEach((data, diaIdx) => {
                        const diaSemana = data.getDay();

                        let etapaDoDia = null;
                        for (let i = 0; i < etapasTipo.length; i++) {
                            const etapa = etapasTipo[i];
                            const inicioData = zerarHorario(criarDataLocal(etapa.data_inicio));
                            const fimDataCalculada = calcularDataFim(etapa.data_inicio, etapa.dias, datas);

                            const dataAtual = zerarHorario(data);

                            if (dataAtual >= inicioData && dataAtual <= fimDataCalculada && diaSemana !== 0 && diaSemana !== 6) {
                                etapaDoDia = { etapa, index: i };
                                break;
                            }
                        }

                        const td = document.createElement('td');
                        if (etapaDoDia) {
                            td.classList.add('bar');
                            td.className = `${etapaDoDia.etapa.etapa}`
                                .toLowerCase()
                                .normalize("NFD")
                                .replace(/[\u0300-\u036f]/g, "")
                                .replace(/\s/g, "")
                                .replace(/[^a-z0-9]/g, "");

                            // td.className = `bar etapa-${etapaDoDia.index + 1}`;
                            td.setAttribute('data-inicio', etapaDoDia.etapa.data_inicio);
                            td.setAttribute('dias-uteis', etapaDoDia.etapa.dias);
                            // td.textContent = etapaDoDia.etapa.etapa;
                        } else {
                            // Se for fim de semana, pode adicionar uma classe para destacar se quiser
                            if (diaSemana === 0 || diaSemana === 6) {
                                td.className = 'fim-de-semana';
                            }
                            // td vazio
                        }
                        tr.appendChild(td);
                    });

                    tbody.appendChild(tr);
                });
            });
        }


        // Buscar dados do PHP (substitua pela URL correta e id_obra real)
        const obraId = localStorage.getItem('obraId'); // ou o nome que você usou no localStorage

        fetch(`tabela.php?id_obra=${obraId}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('obraNome').innerText = data.obra.nome_obra || 'Sem nome';
                const datas = gerarDatas(data.primeiraData, data.ultimaData);
                montarCabecalho(datas);

                // O backend precisa retornar 'data_inicio' e 'data_fim' dentro das etapas para funcionar corretamente
                montarCorpo(data.imagens, data.etapas, datas);
            })
            .catch(e => {
                console.error('Erro ao carregar dados:', e);
            });

    </script>

</body>

</html>